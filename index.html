<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Asset Register</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
  h2 { text-align: center; color: #333; }
  table { width: 100%; border-collapse: collapse; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #009879; color: white; }
  tr:nth-child(even) { background-color: #f2f2f2; }
  input, button { margin: 5px; padding: 6px 10px; }
  #controls { text-align: center; margin-bottom: 15px; }
  button { background: #009879; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background: #007a63; }
  .edit-btn { background-color: #0066cc; }
  .edit-btn:hover { background-color: #004999; }
  .delete-btn { background-color: #cc0000; }
  .delete-btn:hover { background-color: #990000; }
</style>
</head>
<body>

<h2>Asset Register</h2>

<div id="controls">
  <input type="file" id="excelFile" accept=".xlsx, .xls, .csv">
  <input type="text" id="searchInput" placeholder="Search Equipment, User, or DOK B-CORD">
  <button id="clearBtn">Clear All</button>
  <button id="loadGoogle">Load from Google Sheet</button>
</div>

<table id="assetTable">
  <thead>
    <tr>
      <th>Equipment</th>
      <th>Equipment Description</th>
      <th>Serial Number</th>
      <th>DOK B-CORD</th>
      <th>User</th>
      <th>Location</th>
      <th>Edit</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<p id="status" style="text-align:center; color:gray;"></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const tableBody = document.querySelector("#assetTable tbody");
const status = document.getElementById("status");

function normalizeHeader(header) {
  return header.toLowerCase().replace(/\s|_/g, '');
}

function matchHeader(headers, possibleNames) {
  const normalized = headers.map(normalizeHeader);
  for (let name of possibleNames) {
    const index = normalized.indexOf(normalizeHeader(name));
    if (index !== -1) return headers[index];
  }
  return null;
}

// === FILE IMPORT ===
document.getElementById("excelFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    displayData(json);
  };
  reader.readAsArrayBuffer(file);
});

function displayData(records) {
  tableBody.innerHTML = "";
  if (records.length === 0) {
    status.textContent = "No data found.";
    return;
  }

  const headers = Object.keys(records[0]);
  const keys = {
    equipment: matchHeader(headers, ["Equipment", "Equipment Name", "Asset"]),
    desc: matchHeader(headers, ["Equipment Description", "Description", "Details"]),
    serial: matchHeader(headers, ["Serial Number", "Serial", "S/N"]),
    dok: matchHeader(headers, ["DOK B-CORD", "DOK Code", "DOK", "Cord"]),
    user: matchHeader(headers, ["User", "User Name", "Owner"]),
    loc: matchHeader(headers, ["Location", "Place", "Site"])
  };

  let count = 0;
  records.forEach((r) => {
    if (!r[keys.equipment]) return;
    count++;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r[keys.equipment]}</td>
      <td>${r[keys.desc]}</td>
      <td>${r[keys.serial]}</td>
      <td>${r[keys.dok]}</td>
      <td>${r[keys.user]}</td>
      <td>${r[keys.loc]}</td>
      <td><button class="edit-btn" onclick="editRow(this)">Edit</button></td>
      <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
    `;
    tableBody.appendChild(row);
  });

  status.textContent = `‚úÖ Loaded ${count} assets.`;
}

// === SEARCH ===
document.getElementById("searchInput").addEventListener("keyup", function() {
  const filter = this.value.toLowerCase();
  const rows = tableBody.querySelectorAll("tr");
  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    row.style.display = text.includes(filter) ? "" : "none";
  });
});

// === CLEAR ===
document.getElementById("clearBtn").addEventListener("click", function() {
  tableBody.innerHTML = "";
  status.textContent = "Cleared all records.";
});

// === EDIT ===
function editRow(btn) {
  const row = btn.parentNode.parentNode;
  const cells = row.querySelectorAll("td");
  if (btn.textContent === "Edit") {
    for (let i = 0; i < cells.length - 2; i++) {
      const value = cells[i].textContent;
      cells[i].innerHTML = `<input value="${value}">`;
    }
    btn.textContent = "Save";
  } else {
    for (let i = 0; i < cells.length - 2; i++) {
      const input = cells[i].querySelector("input");
      cells[i].textContent = input.value;
    }
    btn.textContent = "Edit";
  }
}

// === DELETE ===
function deleteRow(btn) {
  const row = btn.parentNode.parentNode;
  if (confirm("Are you sure you want to delete this record?")) {
    row.remove();
    status.textContent = "üóëÔ∏è Row deleted successfully.";
  }
}

// === LOAD FROM GOOGLE SHEET ===
document.getElementById("loadGoogle").addEventListener("click", async () => {
  const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1UjaZ2GcqlAW4vQWl1F37zp7DBgCpwbYdTEnqSzJqN5I/export?format=csv";
  try {
    const res = await fetch(GOOGLE_SHEET_URL);
    const csvText = await res.text();

    const workbook = XLSX.read(csvText, { type: "string" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    displayData(json);
  } catch (e) {
    console.error(e);
    status.textContent = "‚ùå Error loading Google Sheet. Make sure link is shared publicly.";
  }
});
</script>
</body>
</html>
